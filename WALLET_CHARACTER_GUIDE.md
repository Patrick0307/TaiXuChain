# 钱包角色绑定功能说明

## 功能概述

现在每个钱包只能创建一个角色，已注册的钱包再次登录时会自动加载已有角色，直接进入地图选择界面。

## 工作流程

### 首次登录（新钱包）
1. 连接钱包
2. 系统检查钱包是否已有角色（显示"Checking for existing character..."）
3. 未找到角色，进入角色创建流程：
   - 选择职业（Warrior/Mage/Archer）
   - 自定义外观
   - 输入角色名称
   - 角色注册到区块链（使用赞助交易，玩家无需支付 gas）
4. 进入地图选择界面

### 再次登录（已有角色的钱包）
1. 连接钱包
2. 系统检查钱包是否已有角色
3. **找到已有角色，自动加载角色信息**
4. **直接跳转到地图选择界面**
5. 显示角色信息：
   - 角色预览（动画）
   - 角色名称
   - 职业
   - 等级
   - 区块链 ID

## 技术实现

### 后端 API

#### 查询玩家角色
```
GET /api/player/:address
```

返回：
```json
{
  "exists": true,
  "player": {
    "objectId": "0x...",
    "name": "角色名称",
    "class": 1,  // 1=Mage, 2=Warrior, 3=Archer
    "level": 1,
    "exp": 0,
    "owner": "0x...",
    "customization": {
      "gender": "male",
      "skinColor": "#ffd4a3",
      "hairStyle": "short",
      "hairColor": "#000000",
      "clothesStyle": "default",
      "clothesColor": "#8b0000",
      "shoesColor": "#4a4a4a"
    }
  }
}
```

### 前端逻辑

1. **钱包连接后自动检查**
   - 调用 `checkExistingPlayer(walletAddress)`
   - 如果找到角色，加载角色数据并跳转到地图选择
   - 如果没有角色，进入正常的角色创建流程

2. **地图选择界面增强**
   - 显示角色动画预览
   - 显示完整角色信息（名称、职业、等级、ID）
   - 准备进入游戏

## 测试步骤

### 测试 1：新钱包首次登录
1. 启动后端：`cd taixu-backend && npm start`
2. 启动前端：`cd taixuchain && npm run dev`
3. 使用一个从未注册过的钱包连接
4. 应该进入角色创建流程
5. 完成角色创建后，进入地图选择

### 测试 2：已有角色的钱包再次登录
1. 刷新页面或重新打开应用
2. 使用刚才创建角色的钱包连接
3. 应该看到"Checking for existing character..."
4. **直接跳转到地图选择界面**
5. 看到之前创建的角色信息和预览

### 测试 3：切换钱包
1. 在地图选择界面，切换到另一个钱包
2. 如果是新钱包，应该进入角色创建流程
3. 如果是已有角色的钱包，应该加载对应的角色

## 注意事项

1. **一个钱包只能有一个角色**
   - 这是通过区块链的 Player 对象实现的
   - Player 对象使用 `transfer::transfer` 转移给玩家，成为 SBT（不可转移）

2. **角色数据存储在区块链上**
   - 角色信息永久保存
   - 可以在任何设备上通过钱包访问

3. **赞助交易**
   - 玩家创建角色时不需要支付 gas
   - 后端的赞助钱包会支付所有费用

4. **角色外观数据**
   - 所有自定义数据都保存在区块链上
   - 再次登录时会完整恢复角色外观

## 下一步开发

- [ ] 添加角色删除功能（如果需要）
- [ ] 添加角色编辑功能（改名、换装等）
- [ ] 实现真正的游戏逻辑
- [ ] 添加多角色支持（如果需要）
